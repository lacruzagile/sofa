include:
  - project: "devops/pipeline/kubernetes-components"
    ref: 1.5.0
    file: "kubernetes-components.template.gitlab-ci.yml"

stages:
  - build
  - test
  - image
  - pre-deploy
  - deploy

variables:
  NO_COLOR: 1

.yarn-job:
  image: node:17
  cache:
    key:
      files:
        - spago.dhall
        - yarn.lock
    paths:
      - .spago
      - node_modules
      - output
  before_script:
    - yarn install

build:
  extends: .yarn-job
  stage: build
  script:
    - yarn build
  artifacts:
    paths:
      - dist

test:
  extends: .yarn-job
  stage: test
  cache:
    policy: pull
  script:
    - yarn test

build-and-push-image:
  stage: image
  only: [ master ]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$NEXUS_REGISTRY\":{\"username\":\"$NEXUS_USER\",\"password\":\"$NEXUS_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --registry-mirror nexus.int.clxnetworks.net:8009
      --context .
      --dockerfile ./docker/Dockerfile
      --destination $NEXUS_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_SHORT_SHA

neuvector:
  stage: pre-deploy
  only: [ master ]
  image: nexus.int.clxnetworks.net:8089/pipeline/neuvector:latest
  variables:
    nexus_user: $NEXUS_USER
    nexus_password: $NEXUS_PASSWORD
    scan_target: $CI_PROJECT_PATH:$CI_COMMIT_SHORT_SHA
  script:
    - scan
  artifacts:
    when: always
    paths:
      - ./nvreport/scan-summary.txt
      - ./nvreport/security-report.csv
      - ./nvreport/scan-repository.json

# Build and publish project documentation.
pages:
  extends: .yarn-job
  stage: deploy
  only: [ master ]
  cache:
    policy: pull
  script:
    - yarn spago docs
    - mv generated-docs/html public
  artifacts:
    paths:
      - public

.deploy-k8s:
  image: alpine:latest
  stage: deploy
  when: manual
  extends:
    - .kubernetes-components
  script:
    - install_dependencies
    - configure_kubectl
    - ensure_namespace
    - >-
      helm upgrade
      --install sofa
      --values ./helm/config/$CI_ENVIRONMENT_NAME.yaml
      --set image.tag=$CI_COMMIT_SHORT_SHA
      ./helm

.stop-k8s:
  image: alpine:latest
  stage: deploy
  when: manual
  extends:
    - .kubernetes-components
  script:
    - install_dependencies
    - configure_kubectl
    - ensure_namespace
    - helm uninstall sofa
    - kubectl get deployment
    - helm list

deploy-k8s-staging:
  extends: .deploy-k8s
  only: [ master ]
  environment:
    name: eu1tst
    on_stop: stop-k8s-staging

stop-k8s-staging:
  extends: .stop-k8s
  only: [ master ]
  environment:
    name: eu1tst
    action: stop

deploy-salesforce-staging:
  image: salesforce/salesforcedx:7.136.1-slim
  stage: deploy
  only: [ master ]
  when: manual
  environment:
    name: sf-staging
  script:
    - >-
      ./salesforce/build-deployment
      --token-base-url https://sofa.eu1tst.bpa.unauth.int.staging.sinch.com
      --ordering-base-url https://sofa.eu1tst.bpa.unauth.int.staging.sinch.com
      --smart-spec-base-url https://smart-solution.eu1tst.bpa.unauth.int.staging.sinch.com
      --deployment-env staging
  artifacts:
    paths: [ dist-sf ]
